name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install WiX Toolset
      run: dotnet tool install --global wix

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish Windows x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x64

    - name: Publish Windows x86
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-x86 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x86

    - name: Publish Windows ARM64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-arm64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-arm64

    - name: Copy exe files for direct download
      run: |
        Copy-Item ./publish/win-x64/SleepStopper.exe ./SleepStopper-windows-x64.exe
        Copy-Item ./publish/win-x86/SleepStopper.exe ./SleepStopper-windows-x86.exe
        Copy-Item ./publish/win-arm64/SleepStopper.exe ./SleepStopper-windows-arm64.exe
      shell: pwsh

    - name: Create Windows x64 zip
      run: Compress-Archive -Path ./publish/win-x64/* -DestinationPath ./SleepStopper-windows-x64.zip
      shell: pwsh

    - name: Create Windows x86 zip
      run: Compress-Archive -Path ./publish/win-x86/* -DestinationPath ./SleepStopper-windows-x86.zip
      shell: pwsh

    - name: Create Windows ARM64 zip
      run: Compress-Archive -Path ./publish/win-arm64/* -DestinationPath ./SleepStopper-windows-arm64.zip
      shell: pwsh

    - name: Create WiX source for x64 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7C">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-x64/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-x64.wxs -Encoding UTF8
      shell: pwsh

    - name: Create WiX source for x86 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7D">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFilesFolder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-x86/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-x86.wxs -Encoding UTF8
      shell: pwsh

    - name: Create WiX source for ARM64 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7E">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-arm64/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-arm64.wxs -Encoding UTF8
      shell: pwsh

    - name: Build MSI installers
      run: |
        wix build SleepStopper-x64.wxs -o SleepStopper-windows-x64.msi -arch x64
        wix build SleepStopper-x86.wxs -o SleepStopper-windows-x86.msi -arch x86
        wix build SleepStopper-arm64.wxs -o SleepStopper-windows-arm64.msi -arch arm64
      shell: pwsh

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          ./SleepStopper-windows-x64.exe
          ./SleepStopper-windows-x86.exe
          ./SleepStopper-windows-arm64.exe
          ./SleepStopper-windows-x64.zip
          ./SleepStopper-windows-x86.zip
          ./SleepStopper-windows-arm64.zip
          ./SleepStopper-windows-x64.msi
          ./SleepStopper-windows-x86.msi
          ./SleepStopper-windows-arm64.msi

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish Linux x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux-x64

    - name: Publish Linux ARM64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r linux-arm64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux-arm64

    - name: Set executable permissions
      run: |
        chmod +x ./publish/linux-x64/SleepStopper
        chmod +x ./publish/linux-arm64/SleepStopper

    - name: Create Linux x64 tarball
      run: |
        mkdir -p ./SleepStopper-linux-x64
        cp -r ./publish/linux-x64/* ./SleepStopper-linux-x64/
        tar -czvf SleepStopper-linux-x64.tar.gz SleepStopper-linux-x64

    - name: Create Linux ARM64 tarball
      run: |
        mkdir -p ./SleepStopper-linux-arm64
        cp -r ./publish/linux-arm64/* ./SleepStopper-linux-arm64/
        tar -czvf SleepStopper-linux-arm64.tar.gz SleepStopper-linux-arm64

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-builds
        path: |
          ./SleepStopper-linux-x64.tar.gz
          ./SleepStopper-linux-arm64.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish macOS x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/osx-x64

    - name: Publish macOS ARM64 (Apple Silicon)
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true -o ./publish/osx-arm64

    - name: Set executable permissions
      run: |
        chmod +x ./publish/osx-x64/SleepStopper
        chmod +x ./publish/osx-arm64/SleepStopper

    - name: Create macOS x64 tarball
      run: |
        mkdir -p ./SleepStopper-macos-x64
        cp -r ./publish/osx-x64/* ./SleepStopper-macos-x64/
        tar -czvf SleepStopper-macos-x64.tar.gz SleepStopper-macos-x64

    - name: Create macOS ARM64 tarball
      run: |
        mkdir -p ./SleepStopper-macos-arm64
        cp -r ./publish/osx-arm64/* ./SleepStopper-macos-arm64/
        tar -czvf SleepStopper-macos-arm64.tar.gz SleepStopper-macos-arm64

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds
        path: |
          ./SleepStopper-macos-x64.tar.gz
          ./SleepStopper-macos-arm64.tar.gz

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts
      run: find artifacts -type f -name "*"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/windows-builds/*.exe
          artifacts/windows-builds/*.msi
          artifacts/windows-builds/*.zip
          artifacts/linux-builds/*.tar.gz
          artifacts/macos-builds/*.tar.gz
        body: |
          ## SleepStopper ${{ github.ref_name }}

          A cross-platform application that prevents your computer from going to sleep.

          ### Installation

          #### Windows (Installer - Recommended)
          1. Download `SleepStopper-windows-x64.msi` (or x86/arm64 for other architectures)
          2. Run the installer
          3. Launch from Start Menu

          #### Windows (Portable)
          - **Direct exe**: Download `SleepStopper-windows-x64.exe` and run directly
          - **Zip archive**: Download `SleepStopper-windows-x64.zip`, extract, and run `SleepStopper.exe`

          #### Linux
          1. Download `SleepStopper-linux-x64.tar.gz` (or arm64 for ARM devices)
          2. Extract: `tar -xzf SleepStopper-linux-x64.tar.gz`
          3. Enter directory: `cd SleepStopper-linux-x64`
          4. Run: `chmod +x SleepStopper && ./SleepStopper`

          #### macOS
          1. Download `SleepStopper-macos-x64.tar.gz` (or arm64 for Apple Silicon)
          2. Extract: `tar -xzf SleepStopper-macos-x64.tar.gz`
          3. Enter directory: `cd SleepStopper-macos-x64`
          4. Run: `chmod +x SleepStopper && ./SleepStopper`
          5. If blocked, go to System Preferences > Security & Privacy > Allow

          ### Usage
          - Click **ACTIVATE** to prevent sleep (button turns red)
          - Click **DEACTIVATE** to allow sleep (button turns green)
          - Close window to minimize to system tray
          - Right-click tray icon for menu (Show/Exit)

          ### Downloads

          | Platform | Architecture | Installer | Portable (exe) | Portable (zip) |
          |----------|--------------|-----------|----------------|----------------|
          | Windows | x64 (64-bit) | `SleepStopper-windows-x64.msi` | `SleepStopper-windows-x64.exe` | `SleepStopper-windows-x64.zip` |
          | Windows | x86 (32-bit) | `SleepStopper-windows-x86.msi` | `SleepStopper-windows-x86.exe` | `SleepStopper-windows-x86.zip` |
          | Windows | ARM64 | `SleepStopper-windows-arm64.msi` | `SleepStopper-windows-arm64.exe` | `SleepStopper-windows-arm64.zip` |

          | Platform | Architecture | Archive |
          |----------|--------------|---------|
          | Linux | x64 (64-bit) | `SleepStopper-linux-x64.tar.gz` |
          | Linux | ARM64 | `SleepStopper-linux-arm64.tar.gz` |
          | macOS | x64 (Intel) | `SleepStopper-macos-x64.tar.gz` |
          | macOS | ARM64 (Apple Silicon) | `SleepStopper-macos-arm64.tar.gz` |
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
