name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install WiX Toolset
      run: dotnet tool install --global wix

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish Windows x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x64

    - name: Publish Windows x86
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-x86 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x86

    - name: Publish Windows ARM64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r win-arm64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-arm64

    - name: Copy exe files for direct download
      run: |
        Copy-Item ./publish/win-x64/SleepStopper.exe ./SleepStopper-windows-x64.exe
        Copy-Item ./publish/win-x86/SleepStopper.exe ./SleepStopper-windows-x86.exe
        Copy-Item ./publish/win-arm64/SleepStopper.exe ./SleepStopper-windows-arm64.exe
      shell: pwsh

    - name: Create Windows x64 zip
      run: Compress-Archive -Path ./publish/win-x64/* -DestinationPath ./SleepStopper-windows-x64.zip
      shell: pwsh

    - name: Create Windows x86 zip
      run: Compress-Archive -Path ./publish/win-x86/* -DestinationPath ./SleepStopper-windows-x86.zip
      shell: pwsh

    - name: Create Windows ARM64 zip
      run: Compress-Archive -Path ./publish/win-arm64/* -DestinationPath ./SleepStopper-windows-arm64.zip
      shell: pwsh

    - name: Create WiX source for x64 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7C">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-x64/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-x64.wxs -Encoding UTF8
      shell: pwsh

    - name: Create WiX source for x86 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7D">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFilesFolder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-x86/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-x86.wxs -Encoding UTF8
      shell: pwsh

    - name: Create WiX source for ARM64 MSI
      run: |
        @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="SleepStopper" Manufacturer="SleepStopper" Version="1.0.0.0" UpgradeCode="6E4C7F2A-8B3D-4E5F-9A1C-2D3E4F5A6B7E">
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <MediaTemplate EmbedCab="yes" />
            <Feature Id="Main">
              <ComponentGroupRef Id="MainComponents" />
            </Feature>
          </Package>
          <Fragment>
            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="SleepStopper" />
            </StandardDirectory>
          </Fragment>
          <Fragment>
            <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
              <Component Id="MainExecutable">
                <File Id="SleepStopperExe" Source="publish/win-arm64/SleepStopper.exe" KeyPath="yes">
                  <Shortcut Id="StartMenuShortcut" Directory="ProgramMenuFolder" Name="SleepStopper" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
                </File>
              </Component>
            </ComponentGroup>
          </Fragment>
        </Wix>
        "@ | Out-File -FilePath SleepStopper-arm64.wxs -Encoding UTF8
      shell: pwsh

    - name: Build MSI installers
      run: |
        wix build SleepStopper-x64.wxs -o SleepStopper-windows-x64.msi -arch x64
        wix build SleepStopper-x86.wxs -o SleepStopper-windows-x86.msi -arch x86
        wix build SleepStopper-arm64.wxs -o SleepStopper-windows-arm64.msi -arch arm64
      shell: pwsh

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          ./SleepStopper-windows-x64.exe
          ./SleepStopper-windows-x86.exe
          ./SleepStopper-windows-arm64.exe
          ./SleepStopper-windows-x64.zip
          ./SleepStopper-windows-x86.zip
          ./SleepStopper-windows-arm64.zip
          ./SleepStopper-windows-x64.msi
          ./SleepStopper-windows-x86.msi
          ./SleepStopper-windows-arm64.msi

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install packaging tools
      run: sudo apt-get update && sudo apt-get install -y rpm

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish Linux x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux-x64

    - name: Publish Linux ARM64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r linux-arm64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux-arm64

    - name: Set executable permissions
      run: |
        chmod +x ./publish/linux-x64/SleepStopper
        chmod +x ./publish/linux-arm64/SleepStopper

    - name: Create Linux x64 tarball
      run: |
        mkdir -p ./SleepStopper-linux-x64
        cp -r ./publish/linux-x64/* ./SleepStopper-linux-x64/
        tar -czvf SleepStopper-linux-x64.tar.gz SleepStopper-linux-x64

    - name: Create Linux ARM64 tarball
      run: |
        mkdir -p ./SleepStopper-linux-arm64
        cp -r ./publish/linux-arm64/* ./SleepStopper-linux-arm64/
        tar -czvf SleepStopper-linux-arm64.tar.gz SleepStopper-linux-arm64

    - name: Create x64 DEB package
      run: |
        mkdir -p deb-x64/DEBIAN
        mkdir -p deb-x64/usr/bin
        mkdir -p deb-x64/usr/share/applications
        mkdir -p deb-x64/usr/share/icons/hicolor/256x256/apps

        cp ./publish/linux-x64/SleepStopper deb-x64/usr/bin/sleepstopper
        chmod +x deb-x64/usr/bin/sleepstopper

        cat > deb-x64/DEBIAN/control << 'CTRL'
        Package: sleepstopper
        Version: 1.0.0
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: SleepStopper
        Description: Cross-platform application to prevent system sleep
         SleepStopper prevents your computer from going to sleep.
         Features toggle button, system tray integration, and activity log.
        CTRL

        cat > deb-x64/usr/share/applications/sleepstopper.desktop << 'DESKTOP'
        [Desktop Entry]
        Name=SleepStopper
        Comment=Prevent system sleep
        Exec=/usr/bin/sleepstopper
        Terminal=false
        Type=Application
        Categories=Utility;
        DESKTOP

        dpkg-deb --build deb-x64 SleepStopper-linux-x64.deb

    - name: Create ARM64 DEB package
      run: |
        mkdir -p deb-arm64/DEBIAN
        mkdir -p deb-arm64/usr/bin
        mkdir -p deb-arm64/usr/share/applications

        cp ./publish/linux-arm64/SleepStopper deb-arm64/usr/bin/sleepstopper
        chmod +x deb-arm64/usr/bin/sleepstopper

        cat > deb-arm64/DEBIAN/control << 'CTRL'
        Package: sleepstopper
        Version: 1.0.0
        Section: utils
        Priority: optional
        Architecture: arm64
        Maintainer: SleepStopper
        Description: Cross-platform application to prevent system sleep
         SleepStopper prevents your computer from going to sleep.
         Features toggle button, system tray integration, and activity log.
        CTRL

        cat > deb-arm64/usr/share/applications/sleepstopper.desktop << 'DESKTOP'
        [Desktop Entry]
        Name=SleepStopper
        Comment=Prevent system sleep
        Exec=/usr/bin/sleepstopper
        Terminal=false
        Type=Application
        Categories=Utility;
        DESKTOP

        dpkg-deb --build deb-arm64 SleepStopper-linux-arm64.deb

    - name: Create x64 RPM package
      run: |
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        mkdir -p rpm-x64-root/usr/bin
        mkdir -p rpm-x64-root/usr/share/applications

        cp ./publish/linux-x64/SleepStopper rpm-x64-root/usr/bin/sleepstopper
        chmod +x rpm-x64-root/usr/bin/sleepstopper

        cat > rpm-x64-root/usr/share/applications/sleepstopper.desktop << 'DESKTOP'
        [Desktop Entry]
        Name=SleepStopper
        Comment=Prevent system sleep
        Exec=/usr/bin/sleepstopper
        Terminal=false
        Type=Application
        Categories=Utility;
        DESKTOP

        cat > ~/rpmbuild/SPECS/sleepstopper-x64.spec << 'SPEC'
        Name: sleepstopper
        Version: 1.0.0
        Release: 1
        Summary: Cross-platform application to prevent system sleep
        License: MIT
        BuildArch: x86_64

        %description
        SleepStopper prevents your computer from going to sleep.
        Features toggle button, system tray integration, and activity log.

        %install
        mkdir -p %{buildroot}/usr/bin
        mkdir -p %{buildroot}/usr/share/applications
        cp -r %{_sourcedir}/rpm-x64-root/usr/* %{buildroot}/usr/

        %files
        /usr/bin/sleepstopper
        /usr/share/applications/sleepstopper.desktop
        SPEC

        cp -r rpm-x64-root ~/rpmbuild/SOURCES/
        rpmbuild -bb ~/rpmbuild/SPECS/sleepstopper-x64.spec --define "_sourcedir $PWD"
        cp ~/rpmbuild/RPMS/x86_64/*.rpm ./SleepStopper-linux-x64.rpm

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-builds
        path: |
          ./SleepStopper-linux-x64.tar.gz
          ./SleepStopper-linux-arm64.tar.gz
          ./SleepStopper-linux-x64.deb
          ./SleepStopper-linux-arm64.deb
          ./SleepStopper-linux-x64.rpm

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish macOS x64
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/osx-x64

    - name: Publish macOS ARM64 (Apple Silicon)
      run: dotnet publish SleepStopper/SleepStopper.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true -o ./publish/osx-arm64

    - name: Set executable permissions
      run: |
        chmod +x ./publish/osx-x64/SleepStopper
        chmod +x ./publish/osx-arm64/SleepStopper

    - name: Create macOS x64 tarball
      run: |
        mkdir -p ./SleepStopper-macos-x64
        cp -r ./publish/osx-x64/* ./SleepStopper-macos-x64/
        tar -czvf SleepStopper-macos-x64.tar.gz SleepStopper-macos-x64

    - name: Create macOS ARM64 tarball
      run: |
        mkdir -p ./SleepStopper-macos-arm64
        cp -r ./publish/osx-arm64/* ./SleepStopper-macos-arm64/
        tar -czvf SleepStopper-macos-arm64.tar.gz SleepStopper-macos-arm64

    - name: Create macOS x64 app bundle and DMG
      run: |
        # Create .app bundle structure
        mkdir -p SleepStopper-x64.app/Contents/MacOS
        mkdir -p SleepStopper-x64.app/Contents/Resources

        # Copy executable
        cp ./publish/osx-x64/SleepStopper SleepStopper-x64.app/Contents/MacOS/SleepStopper
        chmod +x SleepStopper-x64.app/Contents/MacOS/SleepStopper

        # Create Info.plist
        cat > SleepStopper-x64.app/Contents/Info.plist << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>SleepStopper</string>
            <key>CFBundleIdentifier</key>
            <string>com.sleepstopper.app</string>
            <key>CFBundleName</key>
            <string>SleepStopper</string>
            <key>CFBundleDisplayName</key>
            <string>SleepStopper</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        PLIST

        # Create DMG
        mkdir -p dmg-x64
        cp -r SleepStopper-x64.app dmg-x64/SleepStopper.app
        ln -s /Applications dmg-x64/Applications
        hdiutil create -volname "SleepStopper" -srcfolder dmg-x64 -ov -format UDZO SleepStopper-macos-x64.dmg

    - name: Clean up to free disk space
      run: |
        rm -rf ./publish
        rm -rf ./SleepStopper-macos-x64
        rm -rf ./SleepStopper-macos-arm64
        rm -rf dmg-x64
        rm -rf SleepStopper-x64.app

    - name: Create macOS ARM64 app bundle and DMG
      run: |
        # Create .app bundle structure
        mkdir -p SleepStopper-arm64.app/Contents/MacOS
        mkdir -p SleepStopper-arm64.app/Contents/Resources

        # Re-publish for ARM64 only
        dotnet publish SleepStopper/SleepStopper.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true -o ./publish-arm64

        # Copy executable
        cp ./publish-arm64/SleepStopper SleepStopper-arm64.app/Contents/MacOS/SleepStopper
        chmod +x SleepStopper-arm64.app/Contents/MacOS/SleepStopper

        # Create Info.plist
        cat > SleepStopper-arm64.app/Contents/Info.plist << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>SleepStopper</string>
            <key>CFBundleIdentifier</key>
            <string>com.sleepstopper.app</string>
            <key>CFBundleName</key>
            <string>SleepStopper</string>
            <key>CFBundleDisplayName</key>
            <string>SleepStopper</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        PLIST

        # Create DMG
        mkdir -p dmg-arm64
        cp -r SleepStopper-arm64.app dmg-arm64/SleepStopper.app
        ln -s /Applications dmg-arm64/Applications
        hdiutil create -volname "SleepStopper" -srcfolder dmg-arm64 -ov -format UDZO SleepStopper-macos-arm64.dmg

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds
        path: |
          ./SleepStopper-macos-x64.tar.gz
          ./SleepStopper-macos-arm64.tar.gz
          ./SleepStopper-macos-x64.dmg
          ./SleepStopper-macos-arm64.dmg

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts
      run: find artifacts -type f -name "*"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/windows-builds/*.exe
          artifacts/windows-builds/*.msi
          artifacts/windows-builds/*.zip
          artifacts/linux-builds/*.tar.gz
          artifacts/linux-builds/*.deb
          artifacts/linux-builds/*.rpm
          artifacts/macos-builds/*.tar.gz
          artifacts/macos-builds/*.dmg
        body: |
          ## SleepStopper ${{ github.ref_name }}

          A cross-platform application that prevents your computer from going to sleep.

          ### Installation

          #### Windows (Installer - Recommended)
          1. Download `SleepStopper-windows-x64.msi` (or x86/arm64)
          2. Run the installer
          3. Launch from Start Menu

          #### Windows (Portable)
          - **Direct exe**: Download `SleepStopper-windows-x64.exe` and run directly
          - **Zip archive**: Download `SleepStopper-windows-x64.zip`, extract, run `SleepStopper.exe`

          #### Linux (Debian/Ubuntu)
          ```bash
          sudo dpkg -i SleepStopper-linux-x64.deb
          sleepstopper
          ```

          #### Linux (Fedora/RHEL/CentOS)
          ```bash
          sudo rpm -i SleepStopper-linux-x64.rpm
          sleepstopper
          ```

          #### Linux (Portable)
          ```bash
          tar -xzf SleepStopper-linux-x64.tar.gz
          cd SleepStopper-linux-x64
          chmod +x SleepStopper && ./SleepStopper
          ```

          #### macOS (DMG - Recommended)
          1. Download `SleepStopper-macos-x64.dmg` (Intel) or `SleepStopper-macos-arm64.dmg` (Apple Silicon)
          2. Open the DMG file
          3. Drag SleepStopper to Applications
          4. If blocked: System Preferences > Security & Privacy > Allow

          #### macOS (Portable)
          ```bash
          tar -xzf SleepStopper-macos-x64.tar.gz
          cd SleepStopper-macos-x64
          chmod +x SleepStopper && ./SleepStopper
          ```

          ### Usage
          - Click **ACTIVATE** to prevent sleep (button turns red)
          - Click **DEACTIVATE** to allow sleep (button turns green)
          - Close window to minimize to system tray
          - Right-click tray icon for menu (Show/Exit)

          ### Downloads

          #### Windows
          | Architecture | Installer (.msi) | Portable (.exe) | Archive (.zip) |
          |--------------|------------------|-----------------|----------------|
          | x64 (64-bit) | `SleepStopper-windows-x64.msi` | `SleepStopper-windows-x64.exe` | `SleepStopper-windows-x64.zip` |
          | x86 (32-bit) | `SleepStopper-windows-x86.msi` | `SleepStopper-windows-x86.exe` | `SleepStopper-windows-x86.zip` |
          | ARM64 | `SleepStopper-windows-arm64.msi` | `SleepStopper-windows-arm64.exe` | `SleepStopper-windows-arm64.zip` |

          #### Linux
          | Architecture | DEB (Debian/Ubuntu) | RPM (Fedora/RHEL) | Archive (.tar.gz) |
          |--------------|---------------------|-------------------|-------------------|
          | x64 (64-bit) | `SleepStopper-linux-x64.deb` | `SleepStopper-linux-x64.rpm` | `SleepStopper-linux-x64.tar.gz` |
          | ARM64 | `SleepStopper-linux-arm64.deb` | - | `SleepStopper-linux-arm64.tar.gz` |

          #### macOS
          | Architecture | DMG Installer | Archive (.tar.gz) |
          |--------------|---------------|-------------------|
          | x64 (Intel) | `SleepStopper-macos-x64.dmg` | `SleepStopper-macos-x64.tar.gz` |
          | ARM64 (Apple Silicon) | `SleepStopper-macos-arm64.dmg` | `SleepStopper-macos-arm64.tar.gz` |
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
